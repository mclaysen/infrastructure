---
- name: Bootstrap VPS
  hosts: tunnel_hosts
  become: true
  vars_files:
    - group_vars/tunnel_hosts/vault.yml
  handlers:
    - ansible.builtin.import_tasks: vps-tunnel/handlers/main.yml
  tasks:
    - name: Update all packages
      ansible.builtin.dnf:
        name: "*"
        state: latest
        update_cache: true

    - name: Install basic tools
      ansible.builtin.dnf:
        name:
          - curl
          - nano
          - python3-pip
        state: present
    
    - name: Install pexpect for expect module
      ansible.builtin.pip:
        name: pexpect
        executable: pip3
        state: present

    - name: Set timezone
      community.general.timezone:
        name: "{{ timezone }}"

    - name: Setup users
      ansible.builtin.import_tasks: vps-tunnel/tasks/user.yml

    - name: Configure SSH security
      ansible.builtin.import_tasks: vps-tunnel/tasks/ssh.yml

    - name: Configure firewall
      ansible.builtin.import_tasks: vps-tunnel/tasks/firewall.yml

    - name: Install Docker
      ansible.builtin.import_tasks: vps-tunnel/tasks/docker.yml

    - name: Deploy Pangolin
      ansible.builtin.import_tasks: vps-tunnel/tasks/pangolin.yml